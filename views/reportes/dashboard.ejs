<%- include('../partials/header', { title: 'Dashboard de Reportes' }) %>
<%- include('../partials/navbar') %>

<h1>Dashboard de Reportes y Análisis</h1>

<div class="filtros">
    <form method="GET" class="form-inline">
        <div class="form-group">
            <label>Desde:</label>
            <input type="date" name="fechaInicio" value="<%= fechaInicio %>">
        </div>
        <div class="form-group">
            <label>Hasta:</label>
            <input type="date" name="fechaFin" value="<%= fechaFin %>">
        </div>
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </form>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Reservas</h3>
        <p class="stat-number"><%= totalReservas %></p>
    </div>
    <div class="stat-card">
        <h3>Reservas Confirmadas</h3>
        <p class="stat-number"><%= reservasConfirmadas %></p>
    </div>
    <div class="stat-card">
        <h3>Ingresos Totales</h3>
        <p class="stat-number">$<%= parseFloat(ingresosTotales || 0).toLocaleString() %></p>
    </div>
    <div class="stat-card">
        <h3>Satisfacción Promedio</h3>
        <p class="stat-number"><%= promedioSatisfaccion.toFixed(2) %>/5</p>
    </div>
</div>

<% if (typeof ocupacionPorCabana !== 'undefined' && Object.keys(ocupacionPorCabana).length > 0) { %>
<h2>Ocupación por Cabaña</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Cabaña</th>
                <th>Reservas</th>
                <th>Ingresos</th>
            </tr>
        </thead>
        <tbody>
            <% Object.entries(ocupacionPorCabana).forEach(([nombre, datos]) => { %>
            <tr>
                <td><%= nombre %></td>
                <td><%= datos.reservas || 0 %></td>
                <td>$<%= parseFloat(datos.ingresos || 0).toLocaleString() %></td>
            </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } %>

<% if (typeof clientesFrecuentes !== 'undefined' && clientesFrecuentes.length > 0) { %>
<h2>Clientes Más Frecuentes</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Total Reservas</th>
            </tr>
        </thead>
        <tbody>
            <% clientesFrecuentes.forEach(cliente => { %>
            <tr>
                <td><%= cliente.nombre || 'N/A' %></td>
                <td><%= cliente.reservas || 0 %></td>
            </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } %>

<h2>Estadísticas de Satisfacción</h2>
<% if (typeof estadisticasSatisfaccion !== 'undefined' && estadisticasSatisfaccion.totalEncuestas > 0) { %>
<div class="stats-grid" style="margin-bottom: 2rem;">
    <div class="stat-card">
        <h3>Total Encuestas</h3>
        <p class="stat-number"><%= estadisticasSatisfaccion.totalEncuestas %></p>
    </div>
    <div class="stat-card">
        <h3>Calificación General</h3>
        <p class="stat-number"><%= estadisticasSatisfaccion.promedioGeneral.toFixed(2) %>/5</p>
    </div>
    <div class="stat-card">
        <h3>Limpieza</h3>
        <p class="stat-number"><%= estadisticasSatisfaccion.promedioLimpieza.toFixed(2) %>/5</p>
    </div>
    <div class="stat-card">
        <h3>Servicio</h3>
        <p class="stat-number"><%= estadisticasSatisfaccion.promedioServicio.toFixed(2) %>/5</p>
    </div>
    <div class="stat-card">
        <h3>Precio</h3>
        <p class="stat-number"><%= estadisticasSatisfaccion.promedioPrecio.toFixed(2) %>/5</p>
    </div>
    <div class="stat-card">
        <h3>% Recomendarían</h3>
        <p class="stat-number"><%= estadisticasSatisfaccion.porcentajeRecomendaria.toFixed(1) %>%</p>
    </div>
</div>

<div class="table-container">
    <h3>Encuestas Detalladas</h3>
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Cabaña</th>
                <th>General</th>
                <th>Limpieza</th>
                <th>Servicio</th>
                <th>Precio</th>
                <th>Recomendaría</th>
                <th>Comentarios</th>
            </tr>
        </thead>
        <tbody>
            <% if (typeof encuestasDetalladas !== 'undefined' && encuestasDetalladas.length > 0) { %>
                <% encuestasDetalladas.forEach(encuesta => { %>
                <tr>
                    <td><%= new Date(encuesta.createdAt).toLocaleDateString() %></td>
                    <td><%= encuesta.reserva && encuesta.reserva.cliente ? encuesta.reserva.cliente.nombre + ' ' + encuesta.reserva.cliente.apellido : 'N/A' %></td>
                    <td><%= encuesta.reserva && encuesta.reserva.cabana ? encuesta.reserva.cabana.nombre : 'N/A' %></td>
                    <td><%= encuesta.calificacionGeneral || 'N/A' %>/5</td>
                    <td><%= encuesta.calificacionLimpieza || 'N/A' %><%= encuesta.calificacionLimpieza ? '/5' : '' %></td>
                    <td><%= encuesta.calificacionServicio || 'N/A' %><%= encuesta.calificacionServicio ? '/5' : '' %></td>
                    <td><%= encuesta.calificacionPrecio || 'N/A' %><%= encuesta.calificacionPrecio ? '/5' : '' %></td>
                    <td><%= encuesta.recomendaria ? 'Sí' : 'No' %></td>
                    <td><%= encuesta.comentarios || 'Sin comentarios' %></td>
                </tr>
                <% }); %>
            <% } %>
        </tbody>
    </table>
</div>
<% } else { %>
<p>No hay encuestas de satisfacción en el período seleccionado.</p>
<% } %>

<h2>Historial de Ingresos</h2>
<% if (typeof historialIngresos !== 'undefined' && historialIngresos.length > 0) { %>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Cliente</th>
                <th>Monto</th>
                <th>Método de Pago</th>
            </tr>
        </thead>
        <tbody>
            <% historialIngresos.forEach(pago => { %>
            <tr>
                <td><%= new Date(pago.fecha).toLocaleDateString() %></td>
                <td><%= pago.tipo || 'N/A' %></td>
                <td><%= pago.descripcion || 'N/A' %></td>
                <td><%= pago.cliente || 'N/A' %></td>
                <td>$<%= pago.monto.toLocaleString() %></td>
                <td><%= pago.metodoPago || 'N/A' %></td>
            </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } else { %>
<p>No hay ingresos registrados en el período seleccionado.</p>
<% } %>

<%- include('../partials/footer') %>
